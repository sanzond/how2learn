# AI调用跟踪功能说明

## 功能概述

为了便于后期计算API调用的频次情况，我们在AI生成功能中添加了详细的调用记录和统计功能。

## 新增字段

在 `learning.ai.generator` 模型中新增了以下字段：

### 调用记录字段
- `prompt_used` (Text): 记录使用的提示词
- `ai_model_used` (Char): 记录使用的AI模型
- `api_response_raw` (Text): 记录原始API响应
- `tokens_used` (Integer): 记录使用的token数量
- `api_call_time` (Datetime): 记录API调用时间
- `api_response_time` (Float): 记录响应时间（秒）
- `api_cost_estimate` (Float): 预估调用成本
- `call_log` (Text): 详细调用日志

## 记录的信息

每次AI调用都会记录以下信息：

### 1. 基本信息
- 学习集名称
- AI提供商（OpenAI、Google、DeepSeek等）
- 使用的模型名称
- 调用时间

### 2. 性能指标
- 提示词长度（字符数）
- API响应时间
- 预估Token使用量（输入+输出）
- 预估调用成本

### 3. 详细日志
- 完整的调用过程时间线
- 每个步骤的耗时
- JSON解析结果
- 数据导入状态

## 成本估算

系统会根据不同AI提供商的大致费率进行成本估算：

- **OpenAI**: $0.002 / 1K tokens (GPT-3.5-turbo)
- **Google**: $0.001 / 1K tokens (Gemini)
- **DeepSeek**: $0.0001 / 1K tokens
- **Anthropic**: $0.003 / 1K tokens (Claude)

## Token估算方法

使用简化的估算方法：
- 英文文本：约4个字符 = 1个token
- 包含输入提示词和输出响应的总token数

## 统计功能

### 1. 详细视图
在AI生成器表单中添加了三个新标签页：
- **调用详情**: 显示API调用信息和统计数据
- **提示词**: 显示完整的提示词内容
- **原始响应**: 显示API的原始响应内容

### 2. 统计列表
新增"AI调用统计"菜单，提供：
- 所有调用记录的列表视图
- 按模型、状态、日期等分组
- 成本汇总统计
- 搜索和筛选功能

### 3. 筛选选项
- **按状态**: 成功/失败调用
- **按时间**: 今天/本周/本月
- **按成本**: 高成本调用筛选
- **按模型**: 不同AI模型分组

## 日志记录

### 系统日志
每次调用都会在Odoo系统日志中记录：
```
INFO: AI数据生成成功 - 学习集: [名称], 模型: [模型], Token: [数量], 耗时: [时间]s, 成本: $[金额]
```

### 详细日志示例
```
2024-01-15 14:30:15 - 开始生成学习数据
学习集: English Grammar Basics
AI提供商: OpenAI
模型: gpt-3.5-turbo
14:30:15 - 构建提示词
提示词长度: 1250 字符
14:30:16 - 开始调用AI API
14:30:20 - API调用完成，耗时: 4.2秒
响应长度: 2800 字符
预估Token使用: 1012 (输入: 312, 输出: 700)
预估成本: $0.0020
14:30:20 - 开始解析JSON响应
JSON解析成功，数据结构: ['English Grammar Basics']
14:30:21 - 开始导入数据到模型
14:30:22 - 数据导入完成
总耗时: 7.1秒
生成完成！
```

## 使用方法

1. **查看单次调用详情**：
   - 在AI生成器中点击"查看生成数据"
   - 查看"调用统计"标签页

2. **查看所有调用统计**：
   - 进入"配置" → "AI调用统计"
   - 使用筛选器查看特定时间范围或模型的调用

3. **成本分析**：
   - 在统计列表中查看"总成本"汇总
   - 按模型分组比较不同AI的成本效率

## 注意事项

1. **Token估算**: 当前使用简化算法，实际token数可能有差异
2. **成本估算**: 基于公开费率的近似值，实际费用以AI提供商账单为准
3. **存储空间**: 详细日志会占用数据库空间，建议定期清理旧记录
4. **隐私**: 提示词和响应内容包含用户数据，注意数据保护

## 扩展建议

1. 添加更精确的token计算方法
2. 集成实际的API计费信息
3. 添加调用频率限制功能
4. 实现自动化的成本报告
5. 添加调用性能优化建议